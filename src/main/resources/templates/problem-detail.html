<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="~{fragments/head :: common}" />
    <title th:text="${problem.title} + ' - CafeOJ'">Problem Detail</title>
    <!-- Additional dependencies for this page -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- htmx for live updates -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .markdown-body { line-height: 1.7; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 600; }
        .markdown-body p { margin-bottom: 1rem; }
        .markdown-body ul, .markdown-body ol { margin-bottom: 1rem; padding-left: 1.5rem; }
        .markdown-body li { margin-bottom: 0.25rem; }
        .markdown-body pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
        .markdown-body code { font-family: ui-monospace, monospace; font-size: 0.9em; }
        .markdown-body :not(pre) > code { background: #e2e8f0; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
        .dark .markdown-body :not(pre) > code { background: #374151; color: #e5e7eb; }
    </style>
</head>
<body class="mesh-bg min-h-screen transition-colors duration-200">
    <nav th:replace="~{fragments/navbar :: default}" />
    <div class="h-16"></div>

    <!-- Main Content - Two Column Layout -->
    <div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Problem Content -->
        <div class="lg:col-span-2 glass-card rounded-2xl p-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2" th:text="${problem.title}">Problem Title</h1>
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                Time Limit: <span class="font-medium" th:text="${problem.timeLimit}">1.0</span>s &nbsp;|&nbsp;
                Memory Limit: <span class="font-medium" th:text="${problem.memoryLimit}">256</span>MB
            </div>
            
            <!-- Hidden div to store raw markdown -->
            <div id="raw-markdown" class="hidden" th:text="${problem.description}"></div>
            
            <!-- Div where markdown will be rendered -->
            <div id="rendered-content" class="markdown-body text-gray-700 dark:text-gray-300"></div>

            <!-- Sample Test Cases -->
            <div th:if="${sampleCase != null}" class="mt-8">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Sample Test Case</h3>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Input</span>
                        <button class="inline-flex items-center gap-1 text-sm text-primary hover:text-primary-dark transition-colors" onclick="copyToClipboard('sample-input', this)" title="Copy to clipboard">
                            <span class="copy-icon">ðŸ“‹</span>
                            <span class="copy-text">Copy</span>
                        </button>
                    </div>
                    <pre id="sample-input" class="glass-subtle text-gray-800 dark:text-gray-100 p-4 rounded-xl font-mono text-sm overflow-x-auto" th:text="${sampleCase.input}"></pre>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Output</span>
                        <button class="inline-flex items-center gap-1 text-sm text-primary hover:text-primary-dark transition-colors" onclick="copyToClipboard('sample-output', this)" title="Copy to clipboard">
                            <span class="copy-icon">ðŸ“‹</span>
                            <span class="copy-text">Copy</span>
                        </button>
                    </div>
                    <pre id="sample-output" class="glass-subtle text-gray-800 dark:text-gray-100 p-4 rounded-xl font-mono text-sm overflow-x-auto" th:text="${sampleCase.expectedOutput}"></pre>
                </div>
            </div>
        </div>

        <!-- Right Column: Submission -->
        <div class="glass-card rounded-2xl p-6 h-fit sticky top-24">
            <th:block th:replace="~{fragments/submission-panel :: submissionPanel}" />
        </div>
    </div>

    <th:block th:replace="~{fragments/darkmode :: darkModeScript}" />
    <script>
        // Render Markdown with XSS protection and KaTeX math
        document.addEventListener('DOMContentLoaded', function() {
            const rawMarkdown = document.getElementById('raw-markdown').textContent;
            const renderedContent = document.getElementById('rendered-content');
            renderedContent.innerHTML = DOMPurify.sanitize(marked.parse(rawMarkdown));
            
            // Render LaTeX math with KaTeX
            renderMathInElement(renderedContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        });

        // Copy to clipboard function
        function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                const originalText = button.querySelector('.copy-text').textContent;
                const originalIcon = button.querySelector('.copy-icon').textContent;
                
                button.querySelector('.copy-text').textContent = 'Copied!';
                button.querySelector('.copy-icon').textContent = 'âœ“';
                
                setTimeout(function() {
                    button.querySelector('.copy-text').textContent = originalText;
                    button.querySelector('.copy-icon').textContent = originalIcon;
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        }
    </script>
</body>
</html>
